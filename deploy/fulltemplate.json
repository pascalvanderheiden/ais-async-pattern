{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "vaults_mcmaisd_kv_name": {
            "defaultValue": "mcmaisd-kv",
            "type": "String"
        },
        "service_mcmaisd_name": {
            "defaultValue": "mcmaisd",
            "type": "String"
        },
        "components_mcmaisd_ai_name": {
            "defaultValue": "mcmaisd-ai",
            "type": "String"
        },
        "namespaces_mcmaisd_ns_name": {
            "defaultValue": "mcmaisd-ns",
            "type": "String"
        },
        "databaseAccounts_mcmaisd_acc_name": {
            "defaultValue": "mcmaisd-acc",
            "type": "String"
        },
        "workspaces_mcmaisd_ws_name": {
            "defaultValue": "mcmaisd-ws",
            "type": "String"
        }
    },
    "variables": {},
    "resources": [
        {
            "type": "Microsoft.ApiManagement/service",
            "apiVersion": "2020-06-01-preview",
            "name": "[parameters('service_mcmaisd_name')]",
            "location": "West Europe",
            "tags": {
                "Owner": "Monish"
            },
            "sku": {
                "name": "Developer",
                "capacity": 1
            },
            "properties": {
                "publisherEmail": "email@mydomain.com",
                "publisherName": "Microsoft"
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts",
            "apiVersion": "2021-04-15",
            "name": "[parameters('databaseAccounts_mcmaisd_acc_name')]",
            "location": "West Europe",
            "kind": "GlobalDocumentDB",
            "properties": {
                "consistencyPolicy": {
                    "defaultConsistencyLevel": "Session"
                },
                "locations": [
                    {
                        "locationName": "West Europe",
                        "databaseAccountOfferType": "Standard",
                        "enableAutomaticFailover": false,
                        "enableMultipleWriteLocations": false
                    }
                ],
                "databaseAccountOfferType": "Standard",
                "enableAutomaticFailover": false,
                "enableMultipleWriteLocations": false
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
            "apiVersion": "2021-04-15",
            "name": "[concat(parameters('databaseAccounts_mcmaisd_acc_name'), '/mcmaisd-db')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_mcmaisd_acc_name'))]"
            ],
            "properties": {
                "resource": {
                    "id": "mcmaisd-db"
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
            "apiVersion": "2021-04-15",
            "name": "[concat(parameters('databaseAccounts_mcmaisd_acc_name'), '/mcmaisd-db/customer-con')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('databaseAccounts_mcmaisd_acc_name'), 'mcmaisd-db')]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_mcmaisd_acc_name'))]"
            ],
            "properties": {
                "resource": {
                    "id": "customer-con",
                    "partitionKey": {
                        "paths": [
                            "/message/lastName"
                        ],
                        "kind": "Hash"
                    }
                }
            }
        },
        {
            "type": "microsoft.insights/components",
            "apiVersion": "2020-02-02-preview",
            "name": "[parameters('components_mcmaisd_ai_name')]",
            "location": "westeurope",
            "tags": {
                "Owner": "Monish"
            },
            "kind": "other",
            "properties": {
                "Application_Type": "other",
                "IngestionMode": "ApplicationInsights",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
            }
        },
        {
            "type": "Microsoft.KeyVault/vaults",
            "apiVersion": "2021-04-01-preview",
            "name": "[parameters('vaults_mcmaisd_kv_name')]",
            "location": "westeurope",
            "properties": {
                "sku": {
                    "family": "A",
                    "name": "standard"
                },
                "tenantId": "72f988bf-86f1-41af-91ab-2d7cd011db47",
                "accessPolicies": [
                    {
                        "tenantId": "72f988bf-86f1-41af-91ab-2d7cd011db47",
                        "objectId": "6de67c3b-75d8-4ba9-acad-ab2e6f490c16",
                        "permissions": {
                            "keys": [ "All" ],
                            "secrets": [ "All" ],
                            "certificates": [ "All" ],
                            "storage": [ "All" ]
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.KeyVault/vaults/secrets",
            "apiVersion": "2021-04-01-preview",
            "name": "[concat(parameters('vaults_mcmaisd_kv_name'), '/mcmaisdcosmosdb')]",
            "location": "westeurope",
            "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('vaults_mcmaisd_kv_name'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_mcmaisd_acc_name'))]"
            ],
            "properties": {
                "value": "[listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts/', parameters('databaseAccounts_mcmaisd_acc_name')), '2021-04-15').primaryMasterKey]"
            }
        },
        {
            "type": "Microsoft.KeyVault/vaults/secrets",
            "apiVersion": "2020-04-01-preview",
            "name": "[concat(parameters('vaults_mcmaisd_kv_name'), '/mcmaisdservicebus')]",
            "location": "westeurope",
            "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('vaults_mcmaisd_kv_name'))]",
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('namespaces_mcmaisd_ns_name'))]"
            ],
            "properties": {
                "value": "[listKeys(resourceId('Microsoft.ServiceBus/namespaces', parameters('namespaces_mcmaisd_ns_name')), '2017-04-01').primaryConnectionString]"
            }
        },
        {
            "type": "microsoft.operationalinsights/workspaces",
            "apiVersion": "2020-10-01",
            "name": "[parameters('workspaces_mcmaisd_ws_name')]",
            "location": "westeurope",
            "properties": {
                "sku": {
                    "name": "pergb2018"
                },
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
            }
        },
        {
            "type": "Microsoft.ServiceBus/namespaces",
            "apiVersion": "2017-04-01",
            "name": "[parameters('namespaces_mcmaisd_ns_name')]",
            "location": "West Europe",
            "sku": {
                "name": "Premium",
                "tier": "Premium",
                "capacity": 1
            },
            "properties": {
                "zoneRedundant": false
            }
        },
        {
            "type": "Microsoft.ServiceBus/namespaces/queues",
            "apiVersion": "2018-01-01-preview",
            "name": "[concat(parameters('namespaces_mcmaisd_ns_name'), '/customer-queue')]",
            "location": "West Europe",
            "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('namespaces_mcmaisd_ns_name'))]"
            ],
            "properties": {
                "lockDuration": "PT1M",
                "maxSizeInMegabytes": 1024,
                "requiresDuplicateDetection": false,
                "requiresSession": false,
                "defaultMessageTimeToLive": "P10675199DT2H48M5.4775807S",
                "deadLetteringOnMessageExpiration": false,
                "enableBatchedOperations": true,
                "duplicateDetectionHistoryTimeWindow": "PT10M",
                "maxDeliveryCount": 10,
                "status": "Active",
                "autoDeleteOnIdle": "P10675199DT2H48M5.4775807S",
                "enablePartitioning": false,
                "enableExpress": false
            }
        },
        {
            "type": "Microsoft.ApiManagement/service/loggers",
            "apiVersion": "2021-01-01-preview",
            "name": "[concat(parameters('service_mcmaisd_name'), '/', parameters('service_mcmaisd_name'), '-ai')]",
            "dependsOn": [
                "[resourceId('Microsoft.ApiManagement/service', parameters('service_mcmaisd_name'))]"
            ],
            "properties": {
                "loggerType": "applicationInsights",
                "description": "Logger resources to APIM",
                "credentials": {
                    "instrumentationKey": "{{Logger-Credentials--60bf034046346110ac32e87f}}"
                },
                "isBuffered": true
            }
        },
        {
            "type": "Microsoft.ApiManagement/service/diagnostics",
            "apiVersion": "2021-01-01-preview",
            "name": "[concat(parameters('service_mcmaisd_name'), '/applicationinsights')]",
            "dependsOn": [
                "[resourceId('Microsoft.ApiManagement/service', parameters('service_mcmaisd_name'))]",
                "[resourceId('Microsoft.ApiManagement/service/loggers', parameters('service_mcmaisd_name'), concat(parameters('service_mcmaisd_name'), '-ai'))]"
            ],
            "properties": {
                "alwaysLog": "allErrors",
                "httpCorrelationProtocol": "None",
                "logClientIp": true,
                "loggerId": "[resourceId('Microsoft.ApiManagement/service/loggers', parameters('service_mcmaisd_name'), concat(parameters('service_mcmaisd_name'), '-ai'))]",
                "sampling": {
                    "samplingType": "fixed",
                    "percentage": 50
                },
                "frontend": {
                    "request": {
                        "headers": [],
                        "body": {
                            "bytes": 0
                        }
                    },
                    "response": {
                        "headers": [],
                        "body": {
                            "bytes": 0
                        }
                    }
                },
                "backend": {
                    "request": {
                        "headers": [],
                        "body": {
                            "bytes": 0
                        }
                    },
                    "response": {
                        "headers": [],
                        "body": {
                            "bytes": 0
                        }
                    }
                }
            }
        }
    ]
}